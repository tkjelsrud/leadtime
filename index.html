<html>
<head>
  <style>
    body {
      font-family: Verdana;
      font-size: 10px;
    }
    /*#timeline {
      background-color: #EEE;
    }
    #timeline div {
      position: relative;
      background-color: #CCC;
      border: 1px solid grey;
      filter: drop-shadow(6px 6px 6px grey);
    }*/
    #dataGrid {
      /*font-size: 9px !important;*/
      background-color: #FFF;
      padding: 4px;
    }
  	#error {
      color: red; 
      background-color: #DDD;
    }
    th {
      text-align: left;
      font-family: Verdana;
      font-size: 11px;
    }
    td {
      text-align: left;
      font-family: Verdana;
      font-size: 10px;
      vertical-align: top;
    }
    tr:nth-child(even) {background: #EEE}
    .narrow {
      width: 80px;
    }
    .narrownum {
      width: 30px; 
    }
  </style>
  <style>
    .json-container {
  font-size: 10px;
  background-color: #fff;
  color: #808080;
  box-sizing: border-box; }
  .json-container .line {
    margin: 4px 0;
    display: flex;
    justify-content: flex-start; }
  .json-container .caret-icon {
    width: 18px;
    text-align: center;
    cursor: pointer; }
  .json-container .empty-icon {
    width: 18px; }
  .json-container .json-type {
    margin-right: 4px;
    margin-left: 4px; }
  .json-container .json-key {
    color: #444;
    margin-right: 4px;
    margin-left: 4px; }
  .json-container .json-index {
    margin-right: 4px;
    margin-left: 4px; }
  .json-container .json-value {
    margin-left: 8px; }
  .json-container .json-number {
    color: #f9ae58; }
  .json-container .json-boolean {
    color: #ec5f66; }
  .json-container .json-string {
    color: #86b25c; }
  .json-container .json-size {
    margin-right: 4px;
    margin-left: 4px; }
  .json-container .hide {
    display: none; }
  .json-container .fas {
    display: inline-block;
    width: 0;
    height: 0;
    border-style: solid; }
  .json-container .fa-caret-down {
    border-width: 6px 5px 0 5px;
    border-color: #808080 transparent; }
  .json-container .fa-caret-right {
    border-width: 5px 0 5px 6px;
    border-color: transparent transparent transparent #808080; }
  </style>

</head>

<body onpaste="parsePased(event)">
  <div id="error" style="display:none">&nbsp;</div>
  <!--div id="timeline"></div-->
  <div id="dataGrid"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.6.2/dist/chart.min.js"></script>

<script type="text/javascript">
var memory = {'items': {}, 'ppl': {}};

// Table configuration (keep as dynamic as possible)
var config = {
  'filters': ["xo.fields.issuetype.name=='Epic'"],
  'columns': [
    {'title': "Key", 'eval': "xo.key", 'class': 'narrow', 'style': 'apiLink'},
    {'title': "Title", 'eval': "xo.fields.summary"},
    {'title': "Type", 'eval': "xo.fields.issuetype.name", 'class': 'narrow'},
    {'title': "TFam", 'eval': "jiraTechFamilies(xo)", 'class': 'narrow'},
    {'title': "Status", 'eval': "xo.fields.status.name", 'class': 'narrow'},
    {'title': "Reporter", 'eval': "xo.fields.reporter.emailAddress", 'class': 'narrow'},
    {'title': "Assignee", 'eval': "xo.fields.assignee.emailAddress", 'class': 'narrow'},
    {'title': "Labels", 'eval': "xo.fields.labels.join(' ')"},
    {'title': "Data", 'eval': "xo.fields.description.length + ' ' + xo.fields.attachment.length + 'A'", 'class': 'narrow'},
    {'title': "Social", 'eval': "jiraSocialCount(xo)", 'class': 'narrow'},
    {'title': "History", 'eval': "jiraHistory(xo)"},
    {'title': "Leadtime", 'eval': "jiraLeadtime(xo)", 'class': "narrow"},
    {'title': "LT VD", 'eval': "jiraEpicLeadtime(xo, 'Value Definition')", 'class': "narrownum", 'sum': true, 'style': 'dayScale'},
    {'title': "LT ES", 'eval': "jiraEpicLeadtime(xo, 'Explore solutions')", 'class': "narrownum", 'sum': true, 'style': 'dayScale'},
    {'title': "LT SH", 'eval': "jiraEpicLeadtime(xo, 'Specify How')", 'class': "narrownum", 'sum': true, 'style': 'dayScale'},
    {'title': "LT DL", 'eval': "jiraEpicLeadtime(xo, 'Development Lifecycle')", 'class': "narrownum", 'sum': true, 'style': 'dayScale'},
    {'title': "ELinks", 'eval': "jiraEpicLinks(xo).val.split(' ').length", 'class': "narrownum"},
    {'title': "Rel stories", 'eval': "jiraFindStories(xo).val.length", 'class': "narrownum"}
  ]
};
  
var configStory = {
  'filters': ["xo.fields.issuetype.name!='Epic'"],
  'columns': [
    {'title': "Key", 'eval': "xo.key", 'class': 'narrow'},
    {'title': "Title", 'eval': "xo.fields.summary"},
    {'title': "Type", 'eval': "xo.fields.issuetype.name", 'class': 'narrow'},
    {'title': "Status", 'eval': "xo.fields.status.name", 'class': 'narrow'},
    {'title': "Assignee", 'eval': "xo.fields.assignee.emailAddress", 'class': 'narrow'},
    {'title': "Labels", 'eval': "xo.fields.labels.join(' ')"},
    {'title': "Data", 'eval': "xo.fields.description.length + ' ' + xo.fields.attachment.length + 'A'", 'class': 'narrow'},
    {'title': "Social", 'eval': "jiraSocialCount(xo)", 'class': 'narrow'},
    {'title': "History", 'eval': "jiraHistory(xo)"},
    {'title': "Leadtime", 'eval': "jiraLeadtime(xo)", 'class': "narrow"},
    {'title': "LT Ana", 'eval': "jiraEpicLeadtime(xo, 'Analysis')", 'class': "narrownum", 'sum': true, 'style': 'dayScale'},
    {'title': "LT Dev", 'eval': "jiraEpicLeadtime(xo, 'In Progress')", 'class': "narrownum", 'sum': true, 'style': 'dayScale'},
    {'title': "LT SIT", 'eval': "jiraEpicLeadtime(xo, 'SIT')", 'class': "narrownum", 'sum': true, 'style': 'dayScale'},
    {'title': "LT UAT", 'eval': "jiraEpicLeadtime(xo, 'UAT')", 'class': "narrownum", 'sum': true, 'style': 'dayScale'},
    {'title': "LT RPr", 'eval': "jiraEpicLeadtime(xo, 'Ready for production')", 'class': "narrownum", 'sum': true, 'style': 'dayScale'}
  ]
};
  
//"Analysis: 28d 0h 29m, In Progress: 7d 3h 2m, SIT: 6d 20h 58m, UAT: 12d 23h 49m, Ready for production: 16d 4h 30m"

function showError(err) {
  document.getElementById("error").style.display = "block";
  document.getElementById("error").innerText += err;
  
  //TODO: Handle many messages without beeing hidden too early or messages overwritten
  setTimeout(function() {document.getElementById("error").style.display = "none";}, 3000);
}
  
function parsePased(ev) {
  //console.log(ev);
  data = ev.clipboardData.getData("text/plain");
  jsn  = jsonParse(data);
  if(jsn) {
    if(validJiraItem(jsn)) {
      showError("JSON received ok!");
      memory.items[jsn.key] = jsn;
      storeJiraItem(jsn.key, jsn);
      storeItemIndex();
      
      updateTable();
    }
    else {
      showError("JSON received was not parsed as a valid jira item");
    }
  }
  else {
    showError("Value pasted was not parsed as valid JSON");
  }
  
  return false;
}
  
function jsonParse(data) {
  try {
    jsn = JSON.parse(data);
  } catch (e) {
    return null;
  }
  return jsn;
}
  
function validJiraItem(jsn) {
  if(!("fields" in jsn)) return false;
  if(!("changelog" in jsn)) return false;
  
  return true;
}

function getSessionCtx() {
  return window.location.search;
}
  
function storeJiraItem(jkey, jsn) {
  localStorage.setItem(jkey, JSON.stringify(jsn));
}
  
function storeItemIndex() {
  localStorage.setItem("items" + getSessionCtx(), Object.keys(memory.items).join(";"));
}
  
function getApiLink() {
  let link = localStorage.getItem("apiLink");
  if(!link)
    return "#";
  return link;
}

function loadStore() {
  let ind = localStorage.getItem("items" + getSessionCtx());
  if(!ind)
    return false;
  
  ind = ind.split(";");
  
  for(let i = 0; i < ind.length; i++) {
    let data = localStorage.getItem(ind[i]);
    let jsn  = jsonParse(data);
    if(jsn) {
      if(validJiraItem(jsn)) {
        memory.items[jsn.key] = jsn;
        //showError("Loaded " + jsn.key);
      }
    }
  }
}
  
function updateTimeline() {
  document.getElementById("timeline").innerHTML = "";
  
  for(let k in memory.items) {
    let xo = memory.items[k];
    let tLine = document.createElement("div");
    document.getElementById("timeline").appendChild(tLine);
  }
}
  
function updateTable() {
  // Read memory, insert lines
  // Empty old rows
  document.getElementById("dataGrid").innerHTML = "";
  let table = document.createElement("table");
  
  generateTableHead(table, config.columns);
  
  document.getElementById("dataGrid").appendChild(table);
  
  for(let k in memory.items) {
    let xo = memory.items[k];
    let incl = true;
    
    // Check if not filtered (if so: skip)
    for(let i = 0; i < config.filters.length; i++) {
      try {
      	incl = eval(config.filters[i]);
      }
      catch(err) {
        showError("FILTER " + config.columns[i].title + " ERROR " + err);
      }
    }
    
    if(incl) {
    // Calculate row values (jira item)
    let rowData = new Array();
      for(let i = 0; i < config.columns.length; i++) {
        let val = "";
        try {
          val = eval(config.columns[i].eval);
        }
        catch(err) {
          showError("DATA " + config.columns[i].title + " ERROR " + err + " VAL " + val);
        }
        rowData.push(val);
      }

      generateTableRow(table, rowData, config.columns);
    }
  }
  
  //generateTableSummary(table, config.columns);
}
  
function generateTableHead(table, columns) {
  let thead = table.createTHead();
  let row = thead.insertRow();
  for(let i = 0; i < columns.length; i++) {
    let th = document.createElement("th");
    if('class' in columns[i])
    	th.className = columns[i].class;
    let text = document.createTextNode(columns[i].title);
    th.appendChild(text);
    row.appendChild(th);
  }
}
  
function generateTableRow(table, rowData, columns) {
  let row = table.insertRow();
  for(let i = 0; i < rowData.length; i++) {
    let cell = row.insertCell();
    let val = ((Array.isArray(rowData[i]) || typeof rowData[i] === 'object') ? rowData[i].val : rowData[i]);
    let cval = document.createTextNode("" + val);
    
    //if(typeof rowData[i] === 'object' && 'tip' in rowData[i])
    //  cval.setAttribute("title", rowData[i].tip);
    
    if('style' in columns[i]) {
      if(columns[i].style == "dayScale" || val) {
        //console.log(cval);
        let pc = Math.min((parseInt(val) < 1 ? 0: parseInt(val) / 100), 0.9);
        cell.style.backgroundColor = getColor(pc);
       	//cel.style.filter = "brightness(" + parseInt(rowData[i]) + "%)"; 2
      }
      if(columns[i].style == "apiLink") {
        cell.setAttribute('onclick', 'window.open("' + getApiLink() + val + '?expand=changelog", "_blank");');
      }
    }
    //let cval = document.createElement('div');
    //cval.innerHTML = 
    cell.appendChild(cval);
  }
}
  
function jiraSocialCount(xo) {
  // Custom function to count (unique) people involved
  let ppl = {}; 
  ppl = incrVal(ppl, xo.fields.assignee.emailAddress);
  ppl = incrVal(ppl, xo.fields.creator.emailAddress);
  ppl = incrVal(ppl, xo.fields.reporter.emailAddress);
  
  for(let j = 0; j < xo.fields.comment.comments.length; j++) {
    ppl = incrVal(ppl, xo.fields.comment.comments[j].author.emailAddress);
  }
  storePpl(ppl); // also remember across all epics

  return {'val': "ppl:" + Object.keys(ppl).length + " cmt:" + xo.fields.comment.total, 'tip': ppl}
}
  
function incrVal(arr, val) {
  if(val in arr)
    arr[val]++;
  else
    arr[val] = 1;
  
  return arr;
}

function storePpl(pplList) {
  for (const [key, value] of Object.entries(pplList)) {
    memory.ppl = incrVal(memory.ppl, key);
  }
}
  
function jiraSubtaskCount(xo) {
  return "" + xo.fields.subtasks.length;
}
  
function jiraHistory(xo) {
  let res = "";
  if(!xo.changelog || !("histories" in xo.changelog))
    return res;
  // TODO: generated too much string data, right now just rememers last line
  //
  for(let i = 0; i < xo.changelog.histories.length; i++) {
    let hi = xo.changelog.histories[i];
    
    for(let j = 0; j < hi.items.length; j++) {
      let it = hi.items[j];
      if(it.field == "resolution")
        res = shortDate(hi.created) + " reso->" + it.toString + " ";
      if(it.field == "status")
        res = shortDate(hi.created) + " " + it.fromString + "->" + it.toString + " "; //it.fromString 
    }
  }
  return {'val': res};
}
  
function jiraEpicLinks(xo) {
  let res = "";
  if(!xo.changelog || !("histories" in xo.changelog))
    return res;
    
  for(let i = 0; i < xo.changelog.histories.length; i++) {
    let hi = xo.changelog.histories[i];
    
    for(let j = 0; j < hi.items.length; j++) {
      let it = hi.items[j];
      if(it.field == "Epic Child")
        res += it.toString + " ";
    }
  }
  return {'val': res};
}
  
function jiraLeadtime(xo) {
  // Assess if actually done
  let cd = new Date(xo.fields.created);
  let rd = new Date();
  let done = false;
  if(xo.fields.resolutiondate) {
    rd = new Date(xo.fields.resolutiondate);
    done = true;
  }

  return {'val': Math.floor((rd - cd) / (1000*60*60*24)) + "d" + (done ? " (resolved)" : "")};
}
  
function jiraTechFamilies(xo) {
  // Assess if actually done
  let res = new Array();
  for(let i = 0; i < xo.fields.customfield_13515.length; i++) {
    res.push(xo.fields.customfield_13515[i].value);
  }
  
  return {'val': res.join(",")};
}

function jiraEpicLeadtime(xo, filter) {
  //Value Definition: 8d, Explore solutions: 32d, Specify How: 143d, Development Lifecycle: 7d, Done: 2 
  let res = new Array();
  if("customfield_12415" in xo.fields) {
    let arr = xo.fields.customfield_12415.split(',');
    //console.log(arr);
    for(let i = 0; i < arr.length; i++) {
      let ph = arr[i].split(':');
      if(ph.length == 2 && ph[0].trim() == filter) {
        //console.log(ph[0] + " -> " + ph[1]);
        let found = ph[1].match(/([0-9]+)d/);
        if(found[1]) {
          //console.log("Match -> " + found[1] + " found " + found);
          return {'val': found[1]};
          
        }
      }
    }
  }
  else {
    return {'val': 'N/A'};
  }

  return {'val': ''};
}

function jiraFindStories(xo) {
  // Do a regex in all the text
  let str = JSON.stringify(xo);
  const matches = str.match(/[A-Z]+-[0-9]+/g);

  let unique = matches.filter(onlyUnique);
  
  return {'val': unique};
}

function onlyUnique(value, index, self) {
  return self.indexOf(value) === index;
}
  
function shortDate(dateStr) {
  return (new Date(dateStr)).toLocaleDateString('no-nb'); 
}
  
function getColor(value){
  //value from 0 to 1
  var hue=((1-value)*120).toString(10);
  return ["hsl(",hue,",100%,50%)"].join("");
}
  
function getQueryParams(qs) {
  qs = qs.split('+').join(' ');
  var params = {},
        tokens,
        re = /[?&]?([^=]+)=([^&]*)/g;
  while (tokens = re.exec(qs)) {
    params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
  }

  return params;
}
  
document.addEventListener("DOMContentLoaded", function(event) {
  var query = getQueryParams(document.location.search);
  if('c' in query) {
    config = eval(query['c']);
  }
  loadStore();
  updateTable();

  // Last step, update table
  chartSummary();
  chartPeople();
});
</script>

<div id="charter" style="width:400px;height:400px;float:left">
  <canvas id="myChart" width="400" height="400"></canvas>
</div>
<div id="charter_ppl" style="width:400px;height:400px;float:left">
  <canvas id="myChartPpl" width="400" height="400"></canvas>
</div>
<script>

function chartSummary() {
  const ctx = document.getElementById('myChart').getContext('2d');

  // Warning, poor code ahead
  // This is just a hack for now to summarize some columns (hard coded)
  let rows = document.getElementsByTagName("table")[0].rows;
  let sums = {
    'LT': {'data': [], 'min': 999999999999, 'max': 0, 'avg': 0, 'mean': 0, 'maxId': "", 'meanId': "", 'minId': ""},
    'VD': {'data': [], 'min': 999999999999, 'max': 0, 'avg': 0, 'mean': 0, 'maxId': "", 'meanId': "", 'minId': ""},
    'ES': {'data': [], 'min': 999999999999, 'max': 0, 'avg': 0, 'mean': 0, 'maxId': "", 'meanId': "", 'minId': ""},
    'SH': {'data': [], 'min': 999999999999, 'max': 0, 'avg': 0, 'mean': 0, 'maxId': "", 'meanId': "", 'minId': ""},
    'DL': {'data': [], 'min': 999999999999, 'max': 0, 'avg': 0, 'mean': 0, 'maxId': "", 'meanId': "", 'minId': ""}
  };

  for(let i = 1; i < rows.length; i++) {
    let lt = parseInt(rows[i].children[11].textContent);
    sums.LT.data.push(lt)
    if(lt > sums.LT.max) {
      sums.LT.max = lt;
      sums.LT.maxId = rows[i].children[0].textContent;
    }
    if(lt < sums.LT.min) {
      sums.LT.min = lt;
      sums.LT.minId = rows[i].children[0].textContent;
    }

    if(rows[i].children[12].textContent.trim() != "") {
      let vd = parseInt(rows[i].children[12].textContent);
      sums.VD.data.push(vd)
      if(vd > sums.VD.max) {
        sums.VD.max = vd;
        sums.VD.maxId = rows[i].children[0].textContent;
      }
      if(vd < sums.VD.min) {
        sums.VD.min = vd;
        sums.VD.minId = rows[i].children[0].textContent;
      }
    }

    if(rows[i].children[13].textContent.trim() != "") {
      let es = parseInt(rows[i].children[13].textContent);
      sums.ES.data.push(es)
      if(es > sums.ES.max) {
        sums.ES.max = es;
        sums.ES.maxId = rows[i].children[0].textContent;
      }
      if(es < sums.ES.min) {
        sums.ES.min = es;
        sums.ES.minId = rows[i].children[0].textContent;
      }
    }

    if(rows[i].children[14].textContent.trim() != "") {
      let sh = parseInt(rows[i].children[14].textContent);
      sums.SH.data.push(sh)
      if(sh > sums.SH.max) {
        sums.SH.max = sh;
        sums.SH.maxId = rows[i].children[0].textContent;
      }
      if(sh < sums.SH.min) {
        sums.SH.min = sh;
        sums.SH.minId = rows[i].children[0].textContent;
      }
    }

    if(rows[i].children[15].textContent.trim() != "") {
      let dl = parseInt(rows[i].children[15].textContent);
      sums.DL.data.push(dl)
      if(dl > sums.DL.max) {
        sums.DL.max = dl;
        sums.DL.maxId = rows[i].children[0].textContent;
      }
      if(dl < sums.SH.min) {
        sums.DL.min = dl;
        sums.DL.minId = rows[i].children[0].textContent;
      }
    }
  }

  sums.LT.avg = sums.LT.data.reduce((a, b) => a + b, 0) / sums.LT.data.length;
  sums.LT.data.sort(function(a, b){return b-a});
  sums.LT.mean = sums.LT.data[Math.floor(sums.LT.data.length / 2)];
  // Ok so the following does not work, because table is not sorted...
  //sums.LT.meanId = rows[Math.floor(sums.LT.data.length / 2)].children[0].textContent;

  sums.VD.avg = sums.VD.data.reduce((a, b) => a + b, 0) / sums.VD.data.length;
  sums.VD.data.sort(function(a, b){return b-a});
  sums.VD.mean = sums.VD.data[Math.floor(sums.VD.data.length / 2)];

  sums.ES.avg = sums.ES.data.reduce((a, b) => a + b, 0) / sums.ES.data.length;
  sums.ES.data.sort(function(a, b){return b-a});
  sums.ES.mean = sums.ES.data[Math.floor(sums.ES.data.length / 2)];

  sums.SH.avg = sums.SH.data.reduce((a, b) => a + b, 0) / sums.SH.data.length;
  sums.SH.data.sort(function(a, b){return b-a});
  sums.SH.mean = sums.SH.data[Math.floor(sums.SH.data.length / 2)];

  sums.DL.avg = sums.DL.data.reduce((a, b) => a + b, 0) / sums.DL.data.length;
  sums.DL.data.sort(function(a, b){return b-a});
  sums.DL.mean = sums.DL.data[Math.floor(sums.DL.data.length / 2)];
  
  //console.log(sums);
  const myChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: ['Leadtime (total)', 'VD', 'ES', 'SH', 'DL'],
        datasets: [{
            label: 'Min', 
            borderColor: "#e3d2d1",
            data: [sums.LT.min, sums.VD.min, sums.ES.min, sums.SH.min, sums.DL.min]
        },
        {
            label: 'Max',
            borderColor: "#b82921",
            data: [sums.LT.max, sums.VD.max, sums.ES.max, sums.SH.max, sums.DL.max]
        },
        {
            label: 'Avg',
            borderColor: "#507fbf",
            data: [sums.LT.avg, sums.VD.avg, sums.ES.avg, sums.SH.avg, sums.DL.avg]
        },
        {
            label: 'Mean',
            borderColor: "#294294",
            data: [sums.LT.mean, sums.VD.mean, sums.ES.mean, sums.SH.mean, sums.DL.mean]
        }
      
      ]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                suggestedMin: 0,
                suggestedMax: 500
            }
        },
        plugins: {
            title: {
                display: true,
                text: 'Leadtime (' + sums.LT.data.length + ' items)'
            }
        }
    }
});
}

function chartPeople() {
  const ctx = document.getElementById('myChartPpl').getContext('2d');
  //
  // memory.ppl
  //
  const myChart = new Chart(ctx, {
    type: 'pie',
    data: {
        labels: Object.keys(memory.ppl),
        datasets: [{
            label: 'PPL', 
            backgroundColor: new Array(Object.keys(memory.ppl).length).fill("").map(x => "#" + Math.floor(Math.random()*16777215).toString(16)),
            data: Object.values(memory.ppl)
        }
      ]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                suggestedMin: 0,
                suggestedMax: 3
            }
        },
        plugins: {
            title: {
                display: true,
                text: 'Fingerprint (' + Object.keys(memory.ppl).length + ' ppl)'
            }
        }
    }
  });
}

</script>


</body>
</html>
