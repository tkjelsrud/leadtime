<html>
<head>
  <style>
    body {
      font-family: Verdana;
      font-size: 10px;
    }
    #dataGrid {
      /*font-size: 9px !important;*/
      float: left;
    }
  	#error {
      color: red; 
      background-color: #DDD;
    }
  </style>
  <link rel="stylesheet" type="text/css" href="https://pgrabovets.github.io/json-view/jsonview.bundle.css"> 
  <script type="text/javascript" src="https://pgrabovets.github.io/json-view/jsonview.bundle.js"></script>
</head>

<body onpaste="parsePased(event)">
  <div id="error" style="display:none">&nbsp;</div>
  <div id="dataFields" contenteditable="true">xo.key,xo.fields</div>
  <div id="dataGrid"></div>


<script type="text/javascript">
var memory = {'items': {}};

function showError(err) {
  document.getElementById("error").style.display = "block";
  document.getElementById("error").innerText = err;
  
  setTimeout(function() {document.getElementById("error").style.display = "none";}, 3000);
}
  
function parsePased(ev) {
  //console.log(ev);
  data = ev.clipboardData.getData("text/plain");
  jsn  = jsonParse(data);
  if(jsn) {
    if(validJiraItem(jsn)) {
      showError("JSON received ok!");
      memory.items[jsn.key] = jsn;
      storeJiraItem(jsn.key, jsn);
      
      updateTable();
    }
    else {
      showError("JSON received was not parsed as a valid jira item");
    }
  }
  else {
    showError("Value pasted was not parsed as valid JSON");
  }
  
  return false;
}
  
function jsonParse(data) {
  try {
    jsn = JSON.parse(data);
  } catch (e) {
    return null;
  }
  return jsn;
}
  
function validJiraItem(jsn) {
  if(!("fields" in jsn)) return false;
  if(!("changelog" in jsn)) return false;
  
  return true;
}
  
function storeJiraItem(jkey, jsn) {
  localStorage.setItem(jkey, JSON.stringify(jsn));
}
  
function updateTable() {
  // Read memory, insert lines
  // Empty old rows
  document.getElementById("dataGrid").innerHTML = "";
  //document.getElementById("dataGrid").appendChild("<div id=\"root\"></div>");
  query = document.getElementById("dataFields").innerText;
  qList = query.split(",");
  
  for(var k in memory.items) {
    xo = memory.items[k];
    
    for(var i = 0; i < qList.length; i++) {
      query = qList[i];
      jsn = eval(query);

      // Add a new element to grid...
      var d = document.createElement("div");
      d.id = k + "_" + i;
      document.getElementById("dataGrid").appendChild(d)

      if(jsn instanceof String) {
        // Its not json, just dump the text
        document.getElementById(k + "_" + i).innerText = jsn;
      }
      else
        let tree = JsonView.createTree(jsn);
        JsonView.render(tree, document.getElementById(k + "_" + i));
        JsonView.expandChildren(tree);
      }
    }
  }
}
</script>
<script type="text/javascript">

</script>
</body>
</html>
